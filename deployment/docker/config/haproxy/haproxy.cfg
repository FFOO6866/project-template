# HAProxy Configuration for Production MCP Server Load Balancing
# Provides high availability, load balancing, and health checking

global
    # Process configuration
    daemon
    user haproxy
    group haproxy
    
    # Performance tuning
    maxconn 4096
    nbthread 2
    
    # Logging
    log stdout local0 info
    
    # SSL/TLS configuration
    ssl-default-bind-ciphers ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
    ssl-default-bind-options no-sslv3 no-tlsv10 no-tlsv11
    ssl-default-server-ciphers ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
    ssl-default-server-options no-sslv3 no-tlsv10 no-tlsv11
    
    # Stats socket for runtime API
    stats socket /var/run/haproxy.sock mode 600 level admin
    stats timeout 2m

defaults
    mode http
    
    # Timeouts
    timeout connect 5s
    timeout client 30s
    timeout server 30s
    timeout http-request 15s
    timeout http-keep-alive 15s
    
    # Health check settings
    timeout check 5s
    
    # Logging
    option httplog
    option dontlognull
    option log-health-checks
    
    # Connection settings
    option redispatch
    retries 3
    
    # Compression
    compression algo gzip
    compression type text/html text/plain text/css text/javascript application/javascript application/json

# Statistics interface
frontend stats
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 30s
    stats admin if TRUE
    stats show-legends
    stats show-desc "MCP Server Load Balancer Statistics"

# HTTP Frontend (redirect to HTTPS)
frontend mcp_http
    bind *:80
    
    # Redirect HTTP to HTTPS
    redirect scheme https code 301 if !{ ssl_fc }

# HTTPS Frontend
frontend mcp_https
    bind *:443 ssl crt /usr/local/etc/haproxy/ssl/server.pem
    
    # Security headers
    http-response set-header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    http-response set-header X-Frame-Options "DENY"
    http-response set-header X-Content-Type-Options "nosniff"
    http-response set-header X-XSS-Protection "1; mode=block"
    http-response set-header Referrer-Policy "strict-origin-when-cross-origin"
    
    # Rate limiting based on source IP
    stick-table type ip size 100k expire 30s store http_req_rate(10s)
    http-request track-sc0 src
    http-request deny if { sc_http_req_rate(0) gt 20 }
    
    # Health check endpoint (bypass load balancing)
    acl is_health_check path_beg /health
    use_backend mcp_health if is_health_check
    
    # Metrics endpoint (internal only)
    acl is_metrics path_beg /metrics
    acl is_internal_ip src 172.20.0.0/16 127.0.0.1 10.0.0.0/8 192.168.0.0/16
    use_backend mcp_metrics if is_metrics is_internal_ip
    
    # WebSocket upgrade handling
    acl is_websocket hdr(Upgrade) -i websocket
    acl is_websocket_path path_beg /mcp
    use_backend mcp_websocket if is_websocket is_websocket_path
    
    # Management API (admin only)
    acl is_management path_beg /admin /management
    use_backend mcp_management if is_management is_internal_ip
    
    # Default MCP API traffic
    default_backend mcp_servers

# Backend for health checks (round-robin all servers)
backend mcp_health
    balance roundrobin
    option httpchk GET /health
    
    server mcp-server-1 mcp-server-1:3001 check inter 10s fall 3 rise 2
    server mcp-server-2 mcp-server-2:3001 check inter 10s fall 3 rise 2

# Backend for metrics (round-robin metrics ports)
backend mcp_metrics
    balance roundrobin
    option httpchk GET /metrics
    
    server mcp-server-1-metrics mcp-server-1:9090 check inter 30s fall 2 rise 1
    server mcp-server-2-metrics mcp-server-2:9090 check inter 30s fall 2 rise 1

# Backend for WebSocket connections (sticky sessions)
backend mcp_websocket
    balance source
    hash-type consistent
    
    # WebSocket-specific timeouts
    timeout server 5m
    timeout tunnel 1h
    
    # Sticky sessions based on agent ID header
    stick-table type string len 64 size 1000k expire 1h
    stick on hdr(X-Agent-ID)
    
    option httpchk GET /health
    
    server mcp-server-1 mcp-server-1:3001 check inter 15s fall 3 rise 2
    server mcp-server-2 mcp-server-2:3001 check inter 15s fall 3 rise 2

# Backend for management API
backend mcp_management
    balance roundrobin
    option httpchk GET /health
    
    server mcp-server-1-mgmt mcp-server-1:3002 check inter 30s fall 2 rise 1
    server mcp-server-2-mgmt mcp-server-2:3002 check inter 30s fall 2 rise 1

# Main backend for MCP API traffic
backend mcp_servers
    balance leastconn
    
    # Connection pooling and reuse
    option httpchk GET /health
    option http-server-close
    option prefer-last-server
    
    # Server health monitoring
    default-server inter 15s fall 3 rise 2 check maxconn 100
    
    # Circuit breaker pattern
    option redispatch
    retries 2
    
    # Load balancing algorithm with health-based weighting
    server mcp-server-1 mcp-server-1:3001 weight 100 check
    server mcp-server-2 mcp-server-2:3001 weight 100 check
    
    # Backup server configuration (uncomment if needed)
    # server mcp-server-backup mcp-server-backup:3001 backup check

# Error pages customization
errorfile 400 /usr/local/etc/haproxy/errors/400.http
errorfile 403 /usr/local/etc/haproxy/errors/403.http
errorfile 408 /usr/local/etc/haproxy/errors/408.http
errorfile 500 /usr/local/etc/haproxy/errors/500.http
errorfile 502 /usr/local/etc/haproxy/errors/502.http
errorfile 503 /usr/local/etc/haproxy/errors/503.http
errorfile 504 /usr/local/etc/haproxy/errors/504.http

# Logging configuration for container environments
log 127.0.0.1:514 local0 info